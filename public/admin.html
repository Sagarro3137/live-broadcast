<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Admin Broadcast</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="meeting-window">
    <div class="video-box">
      <video id="preview" autoplay playsinline muted></video>
      <div class="live-indicator">LIVE</div>
    </div>
    <div class="controls">
      <button onclick="toggleMic()">ğŸ¤ Mic</button>
      <button onclick="toggleCam()">ğŸ“· Camera</button>
      <button onclick="shareScreen()">ğŸ–¥ï¸ Share Screen</button>
      <button onclick="endMeeting()">âŒ End</button>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script src="https://unpkg.com/simple-peer@9.11.1/simplepeer.min.js"></script>
  <script>
    const socket = io();
    let localStream;
    let peers = {};

    navigator.mediaDevices.getUserMedia({ video: true, audio: true })
      .then(stream => {
        document.getElementById("preview").srcObject = stream;
        localStream = stream;
        socket.emit("join-as-admin");
      });

    socket.on("new-viewer", id => {
      const peer = new SimplePeer({ initiator: true, trickle: false, stream: localStream });

      peer.on("signal", signal => {
        socket.emit("signal", { to: id, signal });
      });

      socket.on("signal", data => {
        if (data.from === id) peer.signal(data.signal);
      });

      peers[id] = peer;
    });

    function toggleMic() {
      localStream.getAudioTracks()[0].enabled = !localStream.getAudioTracks()[0].enabled;
    }
    function toggleCam() {
      localStream.getVideoTracks()[0].enabled = !localStream.getVideoTracks()[0].enabled;
    }
    function shareScreen() {
      navigator.mediaDevices.getDisplayMedia({ video: true }).then(screenStream => {
        const track = screenStream.getTracks()[0];
        for (let id in peers) {
          const sender = peers[id]._pc.getSenders().find(s => s.track.kind === "video");
          sender.replaceTrack(track);
        }
        track.onended = () => {
          for (let id in peers) {
            const sender = peers[id]._pc.getSenders().find(s => s.track.kind === "video");
            sender.replaceTrack(localStream.getVideoTracks()[0]);
          }
        };
      });
    }
    function endMeeting() {
      for (let id in peers) {
        peers[id].destroy();
      }
      peers = {};
      alert("Meeting Ended!");
      window.location.reload();
    }
  </script>
</body>
</html>
